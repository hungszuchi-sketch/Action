<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ›å››å°„å ±åå„€è¡¨æ¿</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Chart.js å‡½å¼åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- è¼‰å…¥ Font Awesome è®“åœ–ç¤ºæ›´è±å¯Œ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Inter:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3ff; /* æ¥µæ·ºç´«è‰²èƒŒæ™¯ */
        }
        .header-title {
            font-family: 'Comfortaa', cursive;
            background: linear-gradient(90deg, #ec4899 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px rgba(236, 72, 153, 0.2);
        }
        .kpi-number {
            font-family: 'Comfortaa', cursive;
            background: linear-gradient(45deg, #ec4899, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
    
    <script>
        // è¨­å®š Tailwind CSS é¡è‰²è®Šæ•¸
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#ec4899', // æ´»åŠ›çš„ç²‰ç´…è‰²
                        'secondary-orange': '#f97316', // æ©˜è‰²
                        'chart-purple': '#a855f7',
                        'chart-yellow': '#facc15',
                    }
                }
            }
        }

        // æ‚¨çš„ Google Apps Script Web App ç¶²å€
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw9HcCnhSkH5Pzyb4Fn1AfUCB1hPWtE6kMCCD9mXWHLVMlc17VI3VYYiNTXiycRAurW/exec';
        
        // åœ–è¡¨å¯¦ä¾‹è®Šæ•¸
        let courseChart, ageChart;

        /**
         * æ¨¡æ“¬ Google Apps Script æ‡‰å›å‚³çš„è³‡æ–™çµæ§‹ã€‚
         * * ğŸš¨ğŸš¨ğŸš¨ é‡è¦ï¼šApps Script å¿…é ˆéƒ¨ç½²ä¸€å€‹ doGet(e) å‡½å¼ä¸¦å›å‚³é¡ä¼¼æ ¼å¼çš„ JSONã€‚ğŸš¨ğŸš¨ğŸš¨
         * * åœ¨æ‚¨çš„ Code.gs ä¸­æ‡‰è©²æœ‰é¡ä¼¼ä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š
         * function doGet(e) {
         * // ... è®€å– Google Sheet è³‡æ–™
         * var data = {
         * totalSignups: 128,
         * avgAge: 24,
         * courseData: {
         * "ç†±èˆå·¥ä½œåŠ": 51, // 40%
         * "å‰µæ„å¡—é´‰ä¹‹å¤œ": 32, // 25%
         * "é›»å­éŸ³æ¨‚è£½ä½œ": 26, // 20%
         * "æ—©æ™¨æ´»åŠ›ç‘œçˆ": 19, // 15%
         * },
         * ageBuckets: [
         * { label: "18æ­²ä»¥ä¸‹", count: 19 },
         * { label: "18-24æ­²", count: 70 },
         * { label: "25-34æ­²", count: 26 },
         * { label: "35æ­²ä»¥ä¸Š", count: 13 }
         * ],
         * recentSignups: [
         * { timestamp: "2025/11/22 10:30", name: "ç‹å°æ˜", course: "é›»å­éŸ³æ¨‚è£½ä½œ", email: "wa***@g.com" },
         * { timestamp: "2025/11/22 09:45", name: "é™³æ€¡å›", course: "ç†±èˆå·¥ä½œåŠ", email: "ch***@h.com" },
         * { timestamp: "2025/11/21 15:00", name: "æ—è±ª", course: "å‰µæ„å¡—é´‰ä¹‹å¤œ", email: "li***@y.com" },
         * { timestamp: "2025/11/20 08:20", name: "å¼µé›…å©·", course: "æ—©æ™¨æ´»åŠ›ç‘œçˆ", email: "ch***@g.com" }
         * ]
         * };
         * return ContentService.createTextOutput(JSON.stringify(data))
         * .setMimeType(ContentService.MimeType.JSON);
         * }
         */
        
        const MOCK_DATA = {
             totalSignups: 128,
             avgAge: 24.3,
             courseData: {
               "ç†±èˆå·¥ä½œåŠ (Dance)": 51,
               "å‰µæ„å¡—é´‰ä¹‹å¤œ (Art)": 32,
               "é›»å­éŸ³æ¨‚è£½ä½œ (Music)": 26,
               "æ—©æ™¨æ´»åŠ›ç‘œçˆ (Yoga)": 19,
             },
             ageBuckets: [
               { label: "18æ­²ä»¥ä¸‹", count: 19 },
               { label: "18-24æ­²", count: 70 },
               { label: "25-34æ­²", count: 26 },
               { label: "35æ­²ä»¥ä¸Š", count: 13 }
             ],
             recentSignups: [
               { timestamp: "2025/11/23 10:30", name: "ç‹å°æ˜", course: "é›»å­éŸ³æ¨‚è£½ä½œ", email: "wa***@g.com" },
               { timestamp: "2025/11/23 09:45", name: "é™³æ€¡å›", course: "ç†±èˆå·¥ä½œåŠ", email: "ch***@h.com" },
               { timestamp: "2025/11/22 15:00", name: "æ—è±ª", course: "å‰µæ„å¡—é´‰ä¹‹å¤œ", email: "li***@y.com" },
               { timestamp: "2025/11/21 08:20", name: "å¼µé›…å©·", course: "æ—©æ™¨æ´»åŠ›ç‘œçˆ", email: "ch***@g.com" },
               { timestamp: "2025/11/20 11:15", name: "å³å¥‡éš†", course: "ç†±èˆå·¥ä½œåŠ", email: "wu***@m.com" },
             ]
        };


        // --- æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        /**
         * è™•ç†éŒ¯èª¤ä¸¦æ›´æ–° UI
         */
        function handleFetchError(message) {
            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('errorMessage').classList.remove('hidden');
            document.getElementById('errorMessage').innerHTML = `<i class="fa-solid fa-triangle-exclamation mr-2"></i> ${message}`;
            document.getElementById('dashboardContent').classList.add('hidden');
        }

        /**
         * ä½¿ç”¨æŒ‡æ•¸é€€é¿ç­–ç•¥é€²è¡Œè³‡æ–™æŠ“å–
         */
        async function fetchWithBackoff(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    // console.log(`Retry ${i + 1} in ${delay.toFixed(0)}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * å¾ Apps Script ç¶²å€æŠ“å–è³‡æ–™
         */
        async function fetchSheetData() {
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            // æ¸¬è©¦ç’°å¢ƒä¸‹ï¼Œç‚ºäº†èƒ½é è¦½ï¼Œå¦‚æœç¶²å€æ˜¯é è¨­å€¼ï¼Œå‰‡ä½¿ç”¨ Mock Data
            if (APPS_SCRIPT_URL.includes('AKfycbw9HcCnhSkH5Pzyb4Fn1AfUCB1hPWtE6kMCCD9mXWHLVMlc17VI3VYYiNTXiycRAurW/exec')) {
                 setTimeout(() => {
                    renderDashboard(MOCK_DATA);
                    document.getElementById('loadingMessage').classList.add('hidden');
                    document.getElementById('dashboardContent').classList.remove('hidden');
                    console.warn("ä½¿ç”¨æ¨¡æ“¬è³‡æ–™é€²è¡Œé è¦½ã€‚è«‹ç¢ºä¿æ‚¨çš„ Apps Script doGet() å‡½å¼å·²è¨­ç½®ä¸¦éƒ¨ç½²ã€‚");
                 }, 1500); // æ¨¡æ“¬ç¶²è·¯å»¶é²
                 return;
            }

            try {
                // Apps Script çš„ doGet è«‹æ±‚é€šå¸¸ä¸éœ€è¦ payloadï¼Œç›´æ¥ GET
                const response = await fetchWithBackoff(APPS_SCRIPT_URL, { method: 'GET' });
                const data = await response.json();
                
                if (data && data.totalSignups !== undefined) {
                    renderDashboard(data);
                    document.getElementById('dashboardContent').classList.remove('hidden');
                } else {
                    throw new Error("Apps Script å›å‚³çš„è³‡æ–™çµæ§‹ä¸æ­£ç¢ºæˆ–ç‚ºç©ºã€‚");
                }
            } catch (error) {
                handleFetchError(`è³‡æ–™æŠ“å–å¤±æ•—ï¼šè«‹ç¢ºèª Apps Script ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œä»¥åŠ doGet() å‡½å¼æ˜¯å¦å·²æ­£ç¢ºéƒ¨ç½²ä¸¦å›å‚³ JSONã€‚ (${error.message})`);
            } finally {
                document.getElementById('loadingMessage').classList.add('hidden');
            }
        }

        /**
         * ç¹ªè£½åœ“é¤…åœ– (Course Distribution)
         */
        function drawCourseChart(data) {
            const courses = Object.keys(data.courseData);
            const counts = Object.values(data.courseData);
            
            const total = counts.reduce((sum, count) => sum + count, 0);
            const percentages = counts.map(count => ((count / total) * 100).toFixed(1) + '%');

            const chartColors = ['#ec4899', '#f97316', '#a855f7', '#facc15'];

            if (courseChart) {
                courseChart.destroy();
            }

            courseChart = new Chart(document.getElementById('courseChart'), {
                type: 'doughnut',
                data: {
                    labels: courses.map((c, i) => `${c} (${percentages[i]})`),
                    datasets: [{
                        data: counts,
                        backgroundColor: chartColors,
                        hoverOffset: 15,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                font: {
                                    size: 16,
                                    family: 'Inter',
                                },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'æ´»å‹•å ±åæ¯”ä¾‹',
                            font: { size: 20, family: 'Comfortaa' },
                            color: '#4b5563',
                            padding: { bottom: 20 }
                        }
                    },
                    cutout: '75%', // ç”œç”œåœˆä¸­é–“çš„å­”æ´
                }
            });
        }

        /**
         * ç¹ªè£½æŸ±ç‹€åœ– (Age Distribution)
         */
        function drawAgeChart(data) {
            const labels = data.ageBuckets.map(b => b.label);
            const counts = data.ageBuckets.map(b => b.count);
            
            if (ageChart) {
                ageChart.destroy();
            }

            ageChart = new Chart(document.getElementById('ageChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'å ±åäººæ•¸',
                        data: counts,
                        backgroundColor: [
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(249, 115, 22, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(250, 202, 21, 0.8)'
                        ],
                        borderColor: [
                            '#ec4899',
                            '#f97316',
                            '#a855f7',
                            '#facc15'
                        ],
                        borderWidth: 1,
                        borderRadius: 8,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: 'å¹´é½¡å±¤åˆ†ä½ˆ',
                            font: { size: 20, family: 'Comfortaa' },
                            color: '#4b5563',
                            padding: { bottom: 20 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'äººæ•¸ (äºº)'
                            }
                        }
                    }
                }
            });
        }

        /**
         * æ¸²æŸ“æœ€æ–°å ±ååˆ—è¡¨
         */
        function renderRecentSignups(data) {
            const tbody = document.getElementById('recentSignupsBody');
            tbody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

            if (data.recentSignups && data.recentSignups.length > 0) {
                data.recentSignups.slice(0, 5).forEach((signup, index) => {
                    const row = tbody.insertRow();
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-pink-50/50';

                    // å ±åæ™‚é–“
                    let timeCell = row.insertCell();
                    timeCell.className = 'py-3 px-4 whitespace-nowrap text-sm text-gray-500';
                    timeCell.textContent = signup.timestamp.split(' ')[1] || signup.timestamp; // åƒ…é¡¯ç¤ºæ™‚é–“æˆ–å…¨éƒ¨

                    // å§“å (åŠ å¯†)
                    let nameCell = row.insertCell();
                    nameCell.className = 'py-3 px-4 whitespace-nowrap text-sm font-medium text-gray-900';
                    nameCell.textContent = `${signup.name.charAt(0)}${'*'.repeat(signup.name.length - 1)}`;

                    // æ´»å‹•èª²ç¨‹
                    let courseCell = row.insertCell();
                    courseCell.className = 'py-3 px-4 whitespace-nowrap text-sm text-gray-700';
                    courseCell.textContent = signup.course;
                    
                    // ç‹€æ…‹ (æœ€æ–°å ±å)
                    let statusCell = row.insertCell();
                    statusCell.className = 'py-3 px-4 whitespace-nowrap text-sm';
                    statusCell.innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">New</span>`;
                });
            } else {
                 const row = tbody.insertRow();
                 const cell = row.insertCell();
                 cell.colSpan = 4;
                 cell.className = 'py-5 text-center text-gray-500 italic';
                 cell.textContent = 'æš«ç„¡æœ€æ–°å ±åè³‡æ–™ã€‚';
            }
        }

        /**
         * ä¸»æ¸²æŸ“å‡½å¼ï¼šä½¿ç”¨å¾ Apps Script ç²å–çš„è³‡æ–™ä¾†æ›´æ–°å„€è¡¨æ¿
         */
        function renderDashboard(data) {
            // 1. æ›´æ–° KPI æ•¸å­—
            document.getElementById('totalSignups').textContent = data.totalSignups.toLocaleString();
            document.getElementById('avgAge').textContent = data.avgAge ? data.avgAge.toFixed(1) : 'N/A';
            
            // 2. ç¹ªè£½èª²ç¨‹åœ“é¤…åœ–
            drawCourseChart(data);

            // 3. ç¹ªè£½å¹´é½¡æŸ±ç‹€åœ–
            drawAgeChart(data);

            // 4. æ¸²æŸ“æœ€æ–°å ±ååˆ—è¡¨
            renderRecentSignups(data);

            // 5. æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œï¼Œé–‹å§‹æŠ“å–è³‡æ–™
        window.onload = function() {
            fetchSheetData();
            // è¨­ç½®å®šæ™‚åˆ·æ–° (ä¾‹å¦‚æ¯ 60 ç§’)
            setInterval(fetchSheetData, 60000); 
        };
    </script>
</head>
<body class="p-6 md:p-10 lg:p-12">

    <!-- ä¸»å„€è¡¨æ¿å®¹å™¨ -->
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- æ¨™é¡Œèˆ‡æ§åˆ¶é … -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4 border-primary-pink/20">
            <h1 class="text-4xl md:text-5xl font-extrabold header-title mb-2 md:mb-0">
                <i class="fa-solid fa-chart-bar mr-3"></i> æ´»å‹•å ±åç¾æ³å„€è¡¨æ¿
            </h1>
            <div class="text-sm text-gray-600 font-medium">
                æœ€å¾Œæ›´æ–°æ™‚é–“: <span id="lastUpdated" class="text-primary-pink font-bold">--:--</span>
                <button onclick="fetchSheetData()" class="ml-3 px-3 py-1 bg-primary-pink text-white rounded-full text-xs hover:bg-secondary-orange transition duration-150 transform hover:scale-105">
                    <i class="fa-solid fa-sync"></i> æ‰‹å‹•åˆ·æ–°
                </button>
            </div>
        </header>

        <!-- è¼‰å…¥ä¸­/éŒ¯èª¤è¨Šæ¯ -->
        <div id="loadingMessage" class="flex items-center justify-center p-6 bg-blue-100 text-blue-700 rounded-xl font-semibold transform transition duration-300">
            <i class="fa-solid fa-spinner fa-spin mr-3"></i> æ­£åœ¨å¾ Google Sheets å–å¾—æœ€æ–°æ•¸æ“š...
        </div>

        <div id="errorMessage" class="hidden p-6 bg-red-100 text-red-700 rounded-xl font-semibold transform transition duration-300">
            <!-- éŒ¯èª¤è¨Šæ¯å°‡ç”± JavaScript å¡«å¯« -->
        </div>

        <!-- å„€è¡¨æ¿å…§å®¹å€å¡Š -->
        <div id="dashboardContent" class="space-y-8 hidden">
            
            <!-- 1. KPI ç¸½è¦½ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                
                <!-- ç¸½å ±åäººæ•¸ -->
                <div class="card bg-white p-6 rounded-2xl border-l-4 border-primary-pink flex items-center">
                    <div class="p-4 bg-primary-pink/10 rounded-full mr-4 text-primary-pink text-3xl">
                        <i class="fa-solid fa-users"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">ç¸½å ±åäººæ•¸</p>
                        <p id="totalSignups" class="kpi-number text-5xl font-extrabold">0</p>
                    </div>
                </div>

                <!-- å¹³å‡å¹´é½¡ -->
                <div class="card bg-white p-6 rounded-2xl border-l-4 border-secondary-orange flex items-center">
                    <div class="p-4 bg-secondary-orange/10 rounded-full mr-4 text-secondary-orange text-3xl">
                        <i class="fa-solid fa-person-half-dress"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">å ±åè€…å¹³å‡å¹´é½¡</p>
                        <p id="avgAge" class="kpi-number text-5xl font-extrabold">0</p>
                    </div>
                </div>

                <!-- æ»¿åº§ç‡ (å¾…æ“´å……) -->
                <div class="card bg-white p-6 rounded-2xl border-l-4 border-chart-purple flex items-center">
                    <div class="p-4 bg-chart-purple/10 rounded-full mr-4 text-chart-purple text-3xl">
                        <i class="fa-solid fa-gauge-high"></i>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">æ´»å‹•æ»¿åº§ç‡ (å‡è¨­ç›®æ¨™150)</p>
                        <!-- ç°¡å–®è¨ˆç®—æ¨¡æ“¬è³‡æ–™çš„æ»¿åº§ç‡ -->
                        <p class="kpi-number text-5xl font-extrabold" id="fillRate">
                            <!-- æ»¿åº§ç‡è¨ˆç®—: (128 / 150) * 100 -->
                            85.3%
                        </p>
                    </div>
                </div>
            </div>

            <!-- 2. åœ–è¡¨å€å¡Š (èª²ç¨‹ & å¹´é½¡åˆ†ä½ˆ) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- èª²ç¨‹åˆ†ä½ˆåœ“é¤…åœ– -->
                <div class="card bg-white p-6 rounded-2xl">
                    <div class="h-96"> <!-- å›ºå®šé«˜åº¦ä»¥ä¾¿ Chart.js æ¸²æŸ“ -->
                        <canvas id="courseChart"></canvas>
                    </div>
                </div>
                
                <!-- å¹´é½¡åˆ†ä½ˆæŸ±ç‹€åœ– -->
                <div class="card bg-white p-6 rounded-2xl">
                    <div class="h-96"> <!-- å›ºå®šé«˜åº¦ä»¥ä¾¿ Chart.js æ¸²æŸ“ -->
                        <canvas id="ageChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 3. æœ€æ–°å ±ååå–® -->
            <div class="card bg-white p-6 rounded-2xl">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center">
                    <i class="fa-solid fa-clipboard-list mr-3 text-secondary-orange"></i> æœ€æ–°å ±ååå–® (Top 5)
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-pink-100">
                        <thead class="bg-pink-100">
                            <tr>
                                <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-pink-700 uppercase tracking-wider">
                                    æ™‚é–“
                                </th>
                                <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-pink-700 uppercase tracking-wider">
                                    å§“å
                                </th>
                                <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-pink-700 uppercase tracking-wider">
                                    å ±åæ´»å‹•
                                </th>
                                <th scope="col" class="py-3 px-4 text-left text-xs font-medium text-pink-700 uppercase tracking-wider">
                                    ç‹€æ…‹
                                </th>
                            </tr>
                        </thead>
                        <tbody id="recentSignupsBody" class="divide-y divide-pink-50">
                            <!-- å ±åè³‡æ–™å°‡ç”± JavaScript æ¸²æŸ“ -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</body>
</html>
